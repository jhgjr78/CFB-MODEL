<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CFB Model — Mobile Dashboard</title>
<style>
:root{--red:#cc0000;--blue:#033366;--soft:#eef3f9;--muted:#f5f5f7}
body{font-family:system-ui,Arial,sans-serif;margin:0;background:#fff;color:#111}
h1{margin:0;padding:12px 14px;background:var(--red);color:#fff;font-weight:700;font-size:20px}
.wrap{padding:12px}
.note{background:#fff3cd;border:1px solid #ffe58f;border-radius:8px;padding:8px 10px;color:#7a5a00;margin-bottom:10px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;white-space:nowrap}
th{position:sticky;top:0;background:#fff;border-bottom:2px solid var(--blue);color:var(--blue)}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:12px}
.col-model{background:var(--soft)}
.col-vegas{background:#f0f0f3}
.col-delta{background:#e8f5ff}
.empty{padding:14px;border:1px dashed #bbb;border-radius:10px;background:#fafafa}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
input,select,button{font-size:14px;padding:6px 8px;border:1px solid #ccc;border-radius:8px}
button{background:var(--blue);color:#fff;border:none}
</style>

<h1>CFB Model — Mobile Dashboard</h1>
<div class="wrap">
  <div class="controls">
    <input id="search" placeholder="Filter teams…" />
    <select id="scope">
      <option value="">All</option>
      <option>home</option><option>away</option><option>favored</option>
      <option>adj_spread</option><option>vegas_spread</option>
      <option>total_pts</option><option>vegas_total</option>
    </select>
    <button id="reload">Reload</button>
  </div>
  <div id="msg" class="note" style="display:none"></div>
  <div id="table"></div>
</div>

<script>
const modelCols = new Set(["adj_spread","base_spread","home_pts","away_pts","total_pts","plays_est","fp","hidden","xpl","sr","havoc","recency"]);
const vegasCols = new Set(["vegas_spread","vegas_total"]);
const deltaCols = new Set(["delta_spread","delta_total"]);

function h(tag, attrs={}, ...kids){
  const el=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
  for(const k of kids) el.append(k?.nodeType? k : document.createTextNode(k));
  return el;
}

function renderTable(rows){
  const host=document.getElementById('table'); host.innerHTML='';
  if(!rows || !rows.length){
    host.append(h('div',{class:'empty'},"No predictions published yet. Run the workflow and refresh."));
    return;
  }
  // auto headers based on keys in first row
  const keys = Object.keys(rows[0]);
  const tbl=h('table'), thead=h('thead'), tr=h('tr');
  for(const k of keys){
    tr.append(h('th',{},k.replace(/_/g,' ')));
  }
  thead.append(tr); tbl.append(thead);
  const tbody=h('tbody');
  for(const r of rows){
    const tr=h('tr');
    for(const k of keys){
      const td=h('td',{}, String(r[k] ?? ''));
      if(modelCols.has(k)) td.classList.add('col-model');
      if(vegasCols.has(k)) td.classList.add('col-vegas');
      if(deltaCols.has(k)) td.classList.add('col-delta');
      tr.append(td);
    }
    tbody.append(tr);
  }
  tbl.append(tbody);
  host.append(tbl);
}

async function load(){
  document.getElementById('msg').style.display='none';
  try{
    const bust = Date.now();
    const res = await fetch(`week_preds.json?t=${bust}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    window._rows = Array.isArray(data)? data: [];
    renderTable(window._rows);
  }catch(err){
    const m=document.getElementById('msg');
    m.style.display='block';
    m.textContent=`Could not load week_preds.json (${err.message}). If you just ran a job, wait ~30s and tap Reload.`;
    renderTable([]);
  }
}

document.getElementById('reload').onclick=load;
document.getElementById('search').oninput=function(){
  const q=this.value.trim().toLowerCase();
  if(!window._rows) return;
  const col=document.getElementById('scope').value;
  const rows = window._rows.filter(r=>{
    if(!q) return true;
    if(col && r[col]!=null) return String(r[col]).toLowerCase().includes(q);
    // search common fields
    return [r.home,r.away,r.favored].some(x=>String(x||'').toLowerCase().includes(q));
  });
  renderTable(rows);
};
load();
</script>